<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Point of sales</title>
    <link rel="stylesheet" href="../hide.css">
</head>
<body>
    <a href="/PointOfSales">กลับ</a>
    <h1>ตั้งค่าหน่วยนับ</h1>
    <button id="add_unit">เพิ่ม</button>
    <table id="unit_table">
        <thead>
            <tr>
                <th>No.</th>
                <th>ชื่อ</th>
                <th>ดำเนินการ</th>
            </tr>
        </thead>
        <tbody>

        </tbody>
    </table>
    <template id="unit_row">
        <tr>
            <td class="no"></td>
            <td class="unit"></td>
            <td>
                <button class="edit_unit">แก้ไข</button>
                <button class="delete_unit">ลบ</button>
            <td>
        </tr>      
    </template>
    <div id="form" class="hide">
        <h1></h1>
        <label for="form_input">ชื่อหน่วย</label>
        <input name="form_input" id="form_input"><br>
        <button id="close">close</button><br>
        <button id="save">save changes</button>
    </div>

    <script type="module">
        import {
            getUnitsList,
            addUnit,
            editUnit,
            deleteUnit
        } from '../api.js'

        async function getTable() { 
            const items = await getUnitsList()

            const table = document.getElementById("unit_table")
            const form = document.getElementById("form")
            const addButton = document.getElementById("add_unit")
            const closeFormButton = document.getElementById("close")

            addButton.addEventListener("click", openAddForm)
            closeFormButton.addEventListener("click", closeForm)

            for (const item of items) {
                const newRow = document.createElement('tr')
                const index = table.rows.length
                var template = document.querySelector('#unit_row')

                var clone = template.content.cloneNode(true)
                clone.querySelector(".no").innerText = index
                clone.querySelector(".unit").innerText = item.name
                clone.querySelector(".edit_unit").addEventListener("click", openEditForm)
                clone.querySelector(".delete_unit").addEventListener("click", deleteItem)

                table.querySelector("tbody").appendChild(clone)

                
                function openEditForm() {
                    form.dataset.for = "Edit"
                    form.classList.remove("hide")
                    form.querySelector("h1").innerText = "แก้ไขหน่วยนับ"
                    form.querySelector("input").value = item.name
                    form.querySelector("#save").addEventListener("click", saveEditForm)
                    document.body.querySelectorAll("*:not(#form, #form *)").forEach(
                        elem => elem.style.pointerEvents = ""
                    )
                }
                
                function saveEditForm() {
                    if (form.dataset.for == "Edit") {
                        editItem()
                    }
                }

                async function editItem() {
                    const editValue = form.querySelector("input").value
                    if (editValue != null) {
                        if (!isInUnits(items, editValue) || (isInUnits(items, editValue) && editValue == items.find(item2 => item2.id == item.id).name)) {
                            await editUnit(item.id, editValue)

                            clearTable()
                            getTable()

                            form.querySelector("#save").removeEventListener("click", saveEditForm)
                            closeForm()
                        }
                        else {
                            alert("Error: Unit duplicated.")
                        }
                        
                    }
                }

                async function deleteItem(event) {
                    await deleteUnit(item.id)

                    clearTable()
                    getTable()
                }
            }

            function openAddForm() {
                form.dataset.for = "Add"
                form.classList.remove("hide")
                form.querySelector("h1").innerText = "เพิ่มหน่วยนับ"
                form.querySelector("input").value = ""
                form.querySelector("#save").addEventListener("click", saveAddForm)
                document.body.querySelectorAll("*:not(#form, #form *)").forEach(
                    elem => elem.style.pointerEvents = "none"
                )
            }

            function closeForm() {
                form.classList.add("hide")
                document.body.querySelectorAll("*:not(#form, #form *)").forEach(
                    elem => elem.style.pointerEvents = ""
                )
            }

            function saveAddForm() {
                if (form.dataset.for == "Add") {
                    addItem()
                }
            }

            async function addItem() {
                const newUnit = form.querySelector("input").value
                if (newUnit != null) {
                    if (!isInUnits(items, newUnit)) {
                        await addUnit(newUnit)

                        clearTable()
                        getTable()

                        form.querySelector("#save").removeEventListener("click", saveAddForm)
                        closeForm()
                    }
                    else {
                        alert("Error: Unit duplicated.")
                    }
                    
                }
            }

            function clearTable() {
                var rowLength = table.rows.length
                for (var i = rowLength - 1; i > 0; i--) {
                    table.deleteRow(i)
                }

                addButton.removeEventListener("click", openAddForm)
                closeFormButton.removeEventListener("click", closeForm)
            }

            function isInUnits(list, item) {
                for (const unit of list) {
                    if (unit.name == item) {
                        return true
                    }
                }

                return false
            }
        }
      
        getTable()
    </script>
</body>
</html>